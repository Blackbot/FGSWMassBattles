<root>
    <template name="mbFactionSectionA">
          <list_sw name="champions">
            <datasource>.ArmyA.champions</datasource>
            <frame name="groupbox"/>
            <anchored>
              <bottom parent="round_label" anchor="top" offset="150"/>
            </anchored>
            <class>mb_champion</class>
            <acceptdrop>
              <class>npc</class>
              <callback>addNpc</callback>
            </acceptdrop>
            <acceptdrop>
              <class>charsheet</class>
              <class>charsheet_mini</class>
              <callback>addPc</callback>
            </acceptdrop>
            <script file="charsheet/scripts/charsheet_localref.lua"/>
            <script file="MassBattles/scripts/mb_championlist.lua"/>
            <script file="MassBattles/scripts/template_championlist.lua"/>
            <empty font="list-empty" textres="mb_emptylist" />
            <sortby>
              <control>name</control>
            </sortby>
          </list_sw>
    </template>
    <template name="mbFactionSectionB">
          <list_sw name="champions">
            <datasource>.ArmyB.champions</datasource>
            <frame name="groupbox"/>
            <anchored>
              <bottom parent="round_label" anchor="top" offset="150"/>
            </anchored>
            <class>mb_champion</class>
            <acceptdrop>
              <class>npc</class>
              <callback>addNpc</callback>
            </acceptdrop>
            <acceptdrop>
              <class>charsheet</class>
              <class>charsheet_mini</class>
              <callback>addPc</callback>
            </acceptdrop>
            <script file="charsheet/scripts/charsheet_localref.lua"/>
            <script file="MassBattles/scripts/mb_championlist.lua"/>
            <script file="MassBattles/scripts/template_championlist.lua"/>
            <empty font="list-empty" textres="mb_emptylist" />
            <sortby>
              <control>name</control>
            </sortby>
          </list_sw>
    </template>
    <template name="mbFactionSectionA_cl">
          <list_sw name="champions">
            <datasource>.ArmyA.champions</datasource>
            <frame name="groupbox"/>
            <anchored>
              <bottom parent="round_label" anchor="top" offset="150"/>
            </anchored>
            <class>mb_champion_cl</class>
            <script file="charsheet/scripts/charsheet_localref.lua"/>
            <script file="MassBattles/scripts/mb_championlist.lua"/>
            <script file="MassBattles/scripts/template_championlist.lua"/>
            <empty font="list-empty" textres="mb_emptylist" />
            <sortby>
              <control>name</control>
            </sortby>
          </list_sw>
    </template>
    <template name="mbFactionSectionB_cl">
          <list_sw name="champions">
            <datasource>.ArmyB.champions</datasource>
            <frame name="groupbox"/>
            <anchored>
              <bottom parent="round_label" anchor="top" offset="150"/>
            </anchored>
            <class>mb_champion_cl</class>
            <script file="charsheet/scripts/charsheet_localref.lua"/>
            <script file="MassBattles/scripts/mb_championlist.lua"/>
            <script file="MassBattles/scripts/template_championlist.lua"/>
            <empty font="list-empty" textres="mb_emptylist" />
            <sortby>
              <control>name</control>
            </sortby>
          </list_sw>
    </template>

  <windowclass name="mb_champion">
    <frame name="ctentrybox"/>
    <sizelimits>
      <minimum height="90" />
    </sizelimits>
    <script file="MassBattles/scripts/mb_champion.lua" />
    <sheetdata>
      <ct_type name="type" />
      <hn name="wildcard" />
      <hs name="tokenrefid" />
      <hs name="tokenrefnode" />
      <hn name="tokenscale">
        <default>1</default>
        <script>
          function onValueChanged()
          window.token.onScaleChanged()
          end
        </script>
      </hn>

      <tokenfield name="token">
        <bounds>74,6,25,25</bounds>
        <empty>indicator_emptytoken</empty>
        <script file="MassBattles/scripts/mb_token.lua" />
      </tokenfield>

      <ct_inc_indicator name="inc">
        <anchored width="25" height="25">
          <top offset="7" />
          <right offset="-52" />
        </anchored>
      </ct_inc_indicator>

      <ct_damagetypes name="damages">
        <anchored width="0">
          <top offset="2" />
          <right parent="inc" anchor="left" offset="-2" />
        </anchored>
      </ct_damagetypes>
      <button_idelete>
        <anchored width="20" height="20">
          <top offset="8" />
          <right parent="damages" anchor="left" offset="-2" relation="relative" />
        </anchored>
        <script>
          function onInit()
          DB.getChild(window.getDatabaseNode(), "inc").onUpdate = onUpdate
          onUpdate()
          end
          function onUpdate()
          setValue(0)
          setVisible(DB.getValue(window.getDatabaseNode(), "inc", 0) == 1)
          end
        </script>
      </button_idelete>
      <genericcontrol name="wildcard_icon">
        <bounds>106,8,25,25</bounds>
        <icon>wildcard</icon>
        <script>
          function updateMenuOptions()
          resetMenuItems()
          if window.type.isNot("pc") then
          registerMenuItem(Interface.getString("wildcard_menu_toggle"), "shuffle", 7)
          end
          end
          function onMenuSelection(...)
          return window.name.onMenuSelection(...)
          end
        </script>
      </genericcontrol>
      <ct_name_host name="name">
        <anchored>
          <right parent="damages"/>
        </anchored>
      </ct_name_host>

      <windowreferencefield name="link">
        <anchored width="20" height="20">
          <top offset="7" />
          <right offset="-6" />
        </anchored>
        <icon normal="button_link" />
        <noreset />
        <script file="ct/scripts/ct_link.lua"/>
      </windowreferencefield>

      <minibennyfield name="bennies">
        <anchored width="20" height="21">
          <top parent="link" />
          <right parent="link" anchor="left" offset="-5" />
        </anchored>
      </minibennyfield>

      <!-- Effects -->
      <ct_section name="effecticon">
        <anchored>
          <top offset="12" />
        </anchored>
        <icon>indicator_effect</icon>
        <script>
          function setSectionVisible(bVisible)
          bVisible = true
          window.effects.setVisible(bVisible)
          window.effects_label.setVisible(bVisible)
          setVisible(bVisible)
          end
        </script>
      </ct_section>
      <windowlist name="effects">
        <anchored>
          <left parent="effecticon" anchor="right" offset="52" />
          <top parent="damages" anchor="bottom" relation="relative" offset="-24" />
          <right offset="-10" />
        </anchored>
        <class>ct_effect</class>
        <datasource>.effects</datasource>
        <script file="ct/scripts/ct_effects.lua"/>
      </windowlist>
      <ct_section_label name="effects_label">
        <anchored to="effects" position="lefthigh" offset="4,6" />
        <static textres="ct_label_effects" />
      </ct_section_label>
      <string_ctentry_effects name="effect_summary">
        <anchored merge="replace">
          <left parent="wildcard_icon" offset="35" />
          <top parent="damages" anchor="bottom" relation="relative" offset="5" />
          <right offset="-17" />
        </anchored>
      </string_ctentry_effects>

      
      <label name="mb_participation_label">
        <anchored>
          <top parent="damages" anchor="bottom" relation="relative"/>
          <left parent="effecticon" anchor="left"/>
        </anchored>
        <static textres="mb_participation_label"/>
      </label>
      <comboboxc name="participation_skill">
        <anchored to="mb_participation_label" position="right" offset="15" width="120">
        </anchored>
        <script file="MassBattles/scripts/participation_combobox.lua"/>
        <default>--</default>
        <listdirection mergerule="replace">down</listdirection>
      </comboboxc>
      <button_text name="participateButton" merge="replace">
        <script>
          function onButtonPress()
            window.makeParticipationRoll(false)
          end
          function onDrop(x,y,dragdata)
            Debug.chat(dragdata)
            if dragdata.getType() == "benny" then
              local bennySource = dragdata.getStringData()
              local actor = dragdata.getDescription()
              Debug.chat("actor",actor)
              rActor={}
              if actor == "GM" then
                Debug.chat("GM")
                rActor["recordname"]="GM"
              else
                rActor["recordname"]=DB.findNode(bennySource).getParent().getParent().getPath()
              end
              Debug.chat(rActor)
              BennyManager.consumeBennyToReRoll(rActor, dragdata.getMetaData("string"), "deebuddleyang")
              window.makeParticipationRoll(true)
            end
          end
        </script>
        <anchored to="participation_skill" position="right" offset="10" width="80"/>
        <text>Participate!</text>
      </button_text>
      <number name="battle_impact_bonus">
        <anchored>
          <top parent="token"/>
          <right parent="token" anchor="left" offset="10"/>
          <left offset="10"/>
        </anchored>
        <readonly/>
        <hideonvalue>0</hideonvalue>
        <displaysign/>
        <font>battle_impact_font</font>
        <tooltip textres="mb_battle_impact_bonus_tooltip"/>
      </number>
      <stringfield name="battle_effect">
        <anchored width="75">
          <top parent="token" anchor="bottom" offset="5"/>
          <right parent="token" anchor="right" offset="5" />
        </anchored>
        <center/>
        <multilinespacing>20</multilinespacing>
        <readonly/>
        <empty>
          <hidereadonly/>
        </empty>
        <font>battle_impact_effect_font</font>
      </stringfield>
      <list_sw name="participationResultList">
        <anchored>
          <top parent="damages" anchor="bottom" relation="relative" offset="10"/>
          <left parent="mb_participation_label" />
          <right parent="effects"/>
        </anchored>
        <datasource>.participation_results</datasource>
        <script file="MassBattles/scripts/template_resultlist.lua"/>
        <script file="MassBattles/scripts/mb_resultlist.lua"/>
        <class>participationResultBox_Window</class>
      </list_sw>
    <vspace name="spacer">
        <anchored height="20">
          <top parent="damages" anchor="bottom" relation="relative" />
          <left />
          <right />
        </anchored>
      </vspace>
</sheetdata>
  </windowclass>
  <windowclass name="mb_champion_cl">
    <frame name="ctentrybox"/>
    <sizelimits>
      <minimum height="90" />
    </sizelimits>
    <script file="MassBattles/scripts/mb_champion_cl.lua" />
    <sheetdata>
      <ct_type name="type" />
      <hn name="wildcard" />
      <hs name="tokenrefid" />
      <hs name="tokenrefnode" />
      <hn name="inc" />
      <hn name="tokenscale">
        <default>1</default>
        <script>
          function onValueChanged()
          window.token.onScaleChanged()
          end
        </script>
      </hn>

      <tokenfield name="token">
        <bounds>74,6,25,25</bounds>
        <empty>indicator_emptytoken</empty>
        <script file="MassBattles/scripts/mb_token.lua" />
      </tokenfield>
      
      <client_mb_state name="state">
        <anchored width="25" height="25">
          <top offset="7" />
          <right offset="-52" />
        </anchored>
      </client_mb_state>

      <ct_client_damagetypes name="damages">
        <anchored width="0">
          <top offset="2" />
          <right parent="state" anchor="left" offset="-2" />
        </anchored>
      </ct_client_damagetypes>
      <button_idelete>
        <anchored width="20" height="20">
          <top offset="8" />
          <right parent="damages" anchor="left" offset="-2" relation="relative" />
        </anchored>
        <script>
          function onInit()
          DB.getChild(window.getDatabaseNode(), "inc").onUpdate = onUpdate
          onUpdate()
          end
          function onUpdate()
          setValue(0)
          setVisible(DB.getValue(window.getDatabaseNode(), "inc", 0) == 1)
          end
        </script>
      </button_idelete>
      <genericcontrol name="wildcard_icon">
        <bounds>105,16,25,25</bounds>
        <icon>wildcard</icon>
      </genericcontrol>
      <ct_name_client name="name">
        <anchored>
          <right parent="damages"/>
        </anchored>
      </ct_name_client>

      <windowreferencefield name="link">
        <anchored width="20" height="20">
          <top offset="7" />
          <right offset="-6" />
        </anchored>
        <icon normal="button_link" />
        <noreset />
        <script file="ct/scripts/ct_link.lua"/>
      </windowreferencefield>

      <minibennyfield name="bennies">
        <anchored width="20" height="21">
          <top parent="link" />
          <right parent="link" anchor="left" offset="-5" />
        </anchored>
      </minibennyfield>

      <windowlist name="effects">
        <anchored>
          <left parent="wildcard_icon" anchor="right" offset="10" />
          <top parent="damages" anchor="bottom" relation="relative" offset="4" />
          <right offset="-10" />
        </anchored>
        <class>client_ct_effect</class>
        <datasource>.effects</datasource>
        <script file="ct/scripts/client_ct_effectlist.lua"/>
      </windowlist>

      
      <label name="mb_participation_label">
        <anchored>
          <top parent="damages" anchor="bottom" relation="relative" offset="4"/>
          <left parent="wildcard_icon" anchor="left"/>
        </anchored>
        <static textres="mb_participation_label"/>
      </label>
      <comboboxc name="participation_skill">
        <anchored to="mb_participation_label" position="right" offset="15" width="120">
        </anchored>
        <script file="MassBattles/scripts/participation_combobox.lua"/>
        <default>--</default>
        <listdirection mergerule="replace">down</listdirection>
      </comboboxc>
      <button_text name="participateButton" merge="replace">
        <script>
          function onButtonPress()
            window.makeParticipationRoll(false)
          end
          function onDrop(x,y,dragdata)
            Debug.chat(dragdata)
            if dragdata.getType() == "benny" then
              local bennySource = dragdata.getStringData()
              local actor = dragdata.getDescription()
              Debug.chat("actor",actor)
              rActor={}
              if actor == "GM" then
                Debug.chat("GM")
                rActor["recordname"]="GM"
              else
                rActor["recordname"]=DB.findNode(bennySource).getParent().getParent().getPath()
              end
              Debug.chat(rActor)
              BennyManager.consumeBennyToReRoll(rActor, dragdata.getMetaData("string"), "deebuddleyang")
              window.makeParticipationRoll(true)
            end
          end
        </script>
        <anchored to="participation_skill" position="right" offset="10" width="80"/>
        <text>Participate!</text>
      </button_text>
      <number name="battle_impact_bonus">
        <anchored>
          <top parent="token"/>
          <right parent="token" anchor="left" offset="10"/>
          <left offset="10"/>
        </anchored>
        <readonly/>
        <hideonvalue>0</hideonvalue>
        <displaysign/>
        <font>battle_impact_font</font>
        <tooltip textres="mb_battle_impact_bonus_tooltip"/>
      </number>
      <stringfield name="battle_effect">
        <anchored width="75">
          <top parent="token" anchor="bottom" offset="5"/>
          <right parent="token" anchor="right" offset="5" />
        </anchored>
        <center/>
        <multilinespacing>20</multilinespacing>
        <readonly/>
        <empty>
          <hidereadonly/>
        </empty>
        <font>battle_impact_effect_font</font>
      </stringfield>
      <list_sw name="participationResultList">
        <anchored>
          <top parent="damages" anchor="bottom" relation="relative" offset="10"/>
          <left parent="mb_participation_label" />
          <right parent="effects"/>
        </anchored>
        <datasource>.participation_results</datasource>
        <script file="MassBattles/scripts/template_resultlist.lua"/>
        <script file="MassBattles/scripts/mb_resultlist.lua"/>
        <class>participationResultBox_Window</class>
      </list_sw>
    <vspace name="spacer">
        <anchored height="20">
          <top parent="damages" anchor="bottom" relation="relative" />
          <left />
          <right />
        </anchored>
      </vspace>
</sheetdata>
  </windowclass>
  <template name="massbattle_left_anchor">
    <genericcontrol>
      <anchored height="0">
        <top parent="title" anchor="bottom" offset="20" />
        <left parent="" anchor="left" offset="30" />
        <right parent="" anchor="right" offset="-50" />
      </anchored>
      <disabled/>
    </genericcontrol>
  </template>
  <template name="massbattle_right_anchor">
    <genericcontrol>
      <anchored height="0">
        <top parent="title" anchor="bottom" offset="20" />
        <left parent="mb_left_anchor" anchor="right" />
        <right parent="" anchor="right" offset="-30" />
      </anchored>
      <disabled/>
    </genericcontrol>
  </template>
  <template name="massbattle_center_anchor">
    <genericcontrol>
      <script>
        local old_on_size_changed=nil
        function onInit()
          reposition()
          if window.onSizeChanged then
            old_on_size_changed = window.onSizeChanged
          end
          window.onSizeChanged=reposition
        end
        function reposition(source)
          w,h = window.getSize()
          self.setAnchor("left","","left","absolute",w/2)
          self.setAnchor("right","","right","absolute",-w/2)
          if old_on_size_changed then
            old_on_size_changed(source)
          end
        end
      </script>
      <anchored position="insidetop" height="0"/>
    </genericcontrol>
  </template>
    <windowclass name="participationResultBox_Window">
      <script file="MassBattles/scripts/participation_result_box.lua"/>
      <frame name="groupbox"/>
      <sheetdata>
        <label name="mb_participation_result_label">
          <anchored>
            <top offset="10"/>
            <left offset="10"/>
          </anchored>
          <static textres="mb_participation_result_label" />
        </label>
        <number name="total">
          <anchored to="mb_participation_result_label" position="right" offset="15"/>
        </number>
        <genericcontrol name="success_indicator">
          <icon>adjust1</icon>
          <anchored to="total" position="right" offset="15" width="15" />
          <invisible/>
        </genericcontrol>
        <genericcontrol name="raise_indicator">
          <icon>adjust2</icon>
          <anchored to="total" position="right" offset="15" width="15" />
          <invisible/>
        </genericcontrol>
        <genericcontrol name="fail_indicator">
          <icon>adjust-1</icon>
          <anchored to="total" position="right" offset="15" width="15" />
          <invisible/>
        </genericcontrol>
        <genericcontrol name="critfail_indicator">
          <icon>adjust-2</icon>
          <anchored to="total" position="right" offset="15" width="15" />
          <invisible/>
        </genericcontrol>
        
        <button_text name="raise_choice_1" merge="replace">
        <script>
          function onButtonPress()
            window.activateRaiseChoicep1()
          end
        </script>
          <anchored width="40" height="16">
            <left parent="total" relation="relative" anchor="right" offset="45"/>
            <top parent="total" offset="2"/>
          </anchored>
        <text>+1</text>
          <invisible/>
      </button_text>
        <label name="raise_choice_or">
          <static textres="mb_raisechoice_or"/>
          <anchored>
            <left parent="total" relation="relative" anchor="right" offset="15"/>
            <top parent="total"/>
          </anchored>
          <invisible/>
        </label>
        <button_text name="raise_choice_battleeffect_button" merge="replace">
        <script>
          function onButtonPress()
            window.activateRaiseChoiceBE()
          end
        </script>
          <anchored width="80" height="16">
            <left parent="total" relation="relative" anchor="right" offset="15"/>
            <top parent="total" offset="2"/>
          </anchored>
          <invisible/>
      </button_text>
        <buttoncontrol name="clear_result_button">
          <tooltipres>mb_clear_result</tooltipres>
          <script>
            function onButtonPress()
              window.deleteParticipationResult()
            end
          </script>
          <anchored width="15">
            <right offset="-15"/>
            <top parent="mb_participation_result_label"/>
            <bottom parent="mb_participation_result_label"/>
          </anchored>
          <icon normal="button_clear" pressed="button_clear_down" />
        </buttoncontrol>
        <button_text name="apply_result_button">
          <script>
            function onButtonPress()
              window.applyParticipationResult()
            end
          </script>
          <anchored width="50" >
            <right offset="-20" parent="clear_result_button"/>
            <top parent="mb_participation_result_label"/>
            <bottom parent="mb_participation_result_label"/>
          </anchored>
          <textres>mb_apply_part_result</textres>
        </button_text>
        <label name="part_wounds">
          <anchored>
            <right parent="apply_result_button" anchor="left" relation="relative" offset="-10"/>
            <top parent="apply_result_button" anchor="top" />
          </anchored>
          <static textres="mb_part_wounds_label"/>
        </label>
        <number name="pending_wounds">
          <anchored>
            <right parent="apply_result_button" anchor="left" relation="relative" offset="-5"/>
            <top parent="apply_result_button" anchor="top" />
            <bottom parent="apply_result_button"/>
          </anchored>
        </number>
        <stringfield name="critfail_battleeffect">
          <anchored to="pending_wounds" position="left" offset="10">
            <right parent="apply_result_button" anchor="left" relation="relative"/>
            <top parent="apply_result_button" anchor="top" />
            <bottom parent="apply_result_button"/>
          </anchored>
        </stringfield>
        <label name="part_fatigues">
          <anchored>
            <right parent="apply_result_button" anchor="left" offset="-10"/>
            <top parent="apply_result_button" anchor="top" />
          </anchored>
          <static textres="mb_part_fatigues_label"/>
        </label>
        <number name="pending_fatigues">
          <anchored to="part_fatigues" position="left" offset="10"/>
        </number>
        <genericcontrol name="tinyspacer">
          <anchored height="10">
            <top parent="mb_participation_result_label" anchor="bottom" position="relative"/>
            <left />
            <right />
          </anchored>
        </genericcontrol>
      </sheetdata>
    </windowclass>
  <template name="vspace">
    <genericcontrol name="spacer">
        <anchored height="20">
          <top parent="damages" anchor="bottom" relation="relative" />
          <left />
          <right />
        </anchored>
      </genericcontrol>
  </template>
  <template name="mbLeaderBSlot_cl">
    <genericcontrol name="mbLeaderB">
      <droptypes>
        <type>shortcut</type>
      </droptypes>
      <stateframe>
        <drophilight>
          <name>modstackfocus</name>
          <offset>0,0,0,8</offset>
          <hidereadonly />
        </drophilight>
      </stateframe>
      <script file="MassBattles/scripts/leaderAslot_cl.lua"/>
    </genericcontrol>
  </template>
  <template name="mbLeaderASlot_cl">
    <genericcontrol name="mbLeaderA">
      <anchored height="35">
        <left />
        <right />
      </anchored>
      <droptypes>
        <type>shortcut</type>
      </droptypes>
      <stateframe>
        <drophilight>
          <name>modstackfocus</name>
          <offset>0,0,0,8</offset>
          <hidereadonly />
        </drophilight>
      </stateframe>
      <script file="MassBattles/scripts/leaderAslot.lua"/>
    </genericcontrol>
  </template>
  <template name="mbLeaderBSlot">
    <genericcontrol name="mbLeaderB">
      <droptypes>
        <type>shortcut</type>
      </droptypes>
      <stateframe>
        <drophilight>
          <name>modstackfocus</name>
          <offset>0,0,0,8</offset>
          <hidereadonly />
        </drophilight>
      </stateframe>
      <script file="MassBattles/scripts/leaderAslot.lua"/>
    </genericcontrol>
  </template>
  <template name="mbLeaderASlot">
    <genericcontrol name="mbLeaderA">
      <anchored height="35">
        <left />
        <right />
      </anchored>
      <droptypes>
        <type>shortcut</type>
      </droptypes>
      <stateframe>
        <drophilight>
          <name>modstackfocus</name>
          <offset>0,0,0,8</offset>
          <hidereadonly />
        </drophilight>
      </stateframe>
      <script file="MassBattles/scripts/leaderAslot.lua"/>
    </genericcontrol>
  </template>
  <template name="mbLeaderADisplayBox_client" >
    <subwindow name="mbLeaderDisplayBox_subwindow_client">
      <class>mbLeaderDisplay_client</class>
      <anchored>
        <left parent="leaderASlot"/>
        <top parent="leaderASlot"/>
        <bottom parent="leaderASlot"/>
        <right parent="leaderASlot"/>
      </anchored>
    </subwindow>
  </template>
  <template name="mbLeaderADisplayBox" >
    <subwindow name="mbLeaderDisplayBox_subwindow">
      <class>mbLeaderDisplay</class>
      <anchored>
        <left parent="leaderASlot"/>
        <top parent="leaderASlot"/>
        <bottom parent="leaderASlot"/>
        <right parent="leaderASlot"/>
      </anchored>
    </subwindow>
  </template>
  <template name="mbLeaderBDisplayBox_client" >
    <subwindow name="mbLeaderDisplayBox_subwindow_client">
      <class>mbLeaderDisplay_client</class>
      <anchored>
        <left parent="leaderBSlot"/>
        <top parent="leaderBSlot"/>
        <bottom parent="leaderBSlot"/>
        <right parent="leaderBSlot"/>
      </anchored>
    </subwindow>
  </template>
  <template name="mbLeaderBDisplayBox" >
    <subwindow name="mbLeaderDisplayBox_subwindow">
      <class>mbLeaderDisplay</class>
      <anchored>
        <left parent="leaderBSlot"/>
        <top parent="leaderBSlot"/>
        <bottom parent="leaderBSlot"/>
        <right parent="leaderBSlot"/>
      </anchored>
    </subwindow>
  </template>
  <windowclass name="mbLeaderDisplay_client">
    <frame name="groupbox"/>
    <script file="MassBattles/scripts/leaderdisplay_client.lua"/>
    <sheetdata>
      <ct_type name="type" />
      <hn name="wildcard" />
      <hn name="inc" />
      <hs name="tokenrefid" />
      <hs name="tokenrefnode" />
      <hn name="tokenscale">
        <default>1</default>
        <script>
          function onValueChanged()
          window.token.onScaleChanged()
          end
        </script>
      </hn>
      
      <tokenfield name="token">
        <bounds>74,6,25,25</bounds>
        <empty>indicator_emptytoken</empty>
        <script file="MassBattles/scripts/mb_token.lua" />
      </tokenfield>
      
      <client_mb_state name="state">
        <anchored width="25" height="25">
          <top offset="7" />
          <right offset="-52" />
        </anchored>
      </client_mb_state>
      <ct_client_damagetypes name="damages">
        <anchored width="0">
          <top offset="2" />
          <right parent="state" anchor="left" offset="-2" />
        </anchored>
      </ct_client_damagetypes>
      <button_idelete>
        <anchored width="20" height="20">
          <top offset="8" />
          <right parent="damages" anchor="left" offset="-2" relation="relative" />
        </anchored>
        <script>
          function onInit()
          DB.getChild(window.getDatabaseNode(), "inc").onUpdate = onUpdate
          onUpdate()
          end
          function onUpdate()
          setValue(0)
          setVisible(DB.getValue(window.getDatabaseNode(), "inc", 0) == 1)
          end
        </script>
      </button_idelete>
      <genericcontrol name="wildcard_icon">
        <bounds>106,8,25,25</bounds>
        <icon>wildcard</icon>
        <script>
          function updateMenuOptions()
          resetMenuItems()
          if window.type.isNot("pc") then
          registerMenuItem(Interface.getString("wildcard_menu_toggle"), "shuffle", 7)
          end
          end
          function onMenuSelection(...)
          return window.name.onMenuSelection(...)
          end
        </script>
      </genericcontrol>
      <ct_name_host name="name">
        <anchored>
          <right parent="damages"/>
        </anchored>
      </ct_name_host>
      
      <windowreferencefield name="link">
        <anchored width="20" height="20">
          <top offset="7" />
          <right offset="-6" />
        </anchored>
        <icon normal="button_link" />
        <noreset />
        <script file="ct/scripts/ct_link.lua"/>
      </windowreferencefield>
      
      <minibennyfield name="bennies">
        <anchored width="20" height="21">
          <top parent="link" />
          <right parent="link" anchor="left" offset="-5" />
        </anchored>
      </minibennyfield>
      
      <windowlist name="effects">
        <anchored>
          <left parent="wildcard_icon" anchor="right" offset="10" />
          <top parent="damages" anchor="bottom" relation="relative" offset="4" />
          <right offset="-10" />
        </anchored>
        <class>client_ct_effect</class>
        <datasource>.effects</datasource>
        <script file="ct/scripts/client_ct_effectlist.lua"/>
      </windowlist>
      
      
      
      <label name="mb_command_label">
        <anchored>
          <top parent="damages" anchor="bottom" relation="relative" offset="4"/>
          <left parent="wildcard_icon" anchor="left"/>
        </anchored>
        <static textres="mb_command_label"/>
      </label>
      <comboboxc name="command_skill">
        <anchored to="mb_command_label" position="right" offset="15" width="120">
        </anchored>
        <script file="MassBattles/scripts/participation_combobox.lua"/>
        <default>--</default>
        <listdirection mergerule="replace">down</listdirection>
      </comboboxc>
      <button_text name="commandButton" merge="replace">
        <script>
          function onButtonPress()
          local sActorType, sActorLink = window.link.getValue()
          local sSkill = window.command_skill.getValue()
          local nodeActor = DB.findNode(sActorLink)
          ModifierManager.applyEffectModifierOnEntity(sActorType, nodeActor, "battlecommand")
          local sDescPrefix = Interface.getString("mb_command_roll_prefix")
          local nodeTrait = SkillManager.getSkillNode(nodeActor, sSkill, true)
          TraitManager.rollPreDefinedRoll(sActorType, nodeActor, nodeTrait, sDescPrefix, "battlecommand", {["mb_entry"]=window.getDatabaseNode().getPath()})
          end
        </script>
        <anchored to="command_skill" position="right" offset="10" width="80"/>
        <text>Command!</text>
      </button_text>
      
      <vspace name="spacer">
        <anchored height="20">
          <top parent="damages" anchor="bottom" relation="relative" />
          <left />
          <right />
        </anchored>
      </vspace>
    </sheetdata>
  </windowclass>
  <windowclass name="mbLeaderDisplay">
    <frame name="groupbox"/>
    <script file="MassBattles/scripts/leaderdisplay.lua"/>
    <sheetdata>
      <ct_type name="type" />
      <hn name="wildcard" />
      <hs name="tokenrefid" />
      <hs name="tokenrefnode" />
      <hn name="tokenscale">
        <default>1</default>
        <script>
          function onValueChanged()
          window.token.onScaleChanged()
          end
        </script>
      </hn>
      
      <tokenfield name="token">
        <bounds>74,6,25,25</bounds>
        <empty>indicator_emptytoken</empty>
        <script file="MassBattles/scripts/mb_token.lua" />
      </tokenfield>
      
      <ct_inc_indicator name="inc">
        <anchored width="25" height="25">
          <top offset="7" />
          <right offset="-52" />
        </anchored>
      </ct_inc_indicator>
      
      <ct_damagetypes name="damages">
        <anchored width="0">
          <top offset="2" />
          <right parent="inc" anchor="left" offset="-2" />
        </anchored>
      </ct_damagetypes>
      <button_idelete>
        <anchored width="20" height="20">
          <top offset="8" />
          <right parent="damages" anchor="left" offset="-2" relation="relative" />
        </anchored>
        <script>
          function onInit()
          DB.getChild(window.getDatabaseNode(), "inc").onUpdate = onUpdate
          onUpdate()
          end
          function onUpdate()
          setValue(0)
          setVisible(DB.getValue(window.getDatabaseNode(), "inc", 0) == 1)
          end
        </script>
      </button_idelete>
      <genericcontrol name="wildcard_icon">
        <bounds>106,8,25,25</bounds>
        <icon>wildcard</icon>
        <script>
          function updateMenuOptions()
          resetMenuItems()
          if window.type.isNot("pc") then
          registerMenuItem(Interface.getString("wildcard_menu_toggle"), "shuffle", 7)
          end
          end
          function onMenuSelection(...)
          return window.name.onMenuSelection(...)
          end
        </script>
      </genericcontrol>
      <ct_name_host name="name">
        <anchored>
          <right parent="damages"/>
        </anchored>
      </ct_name_host>
      
      <windowreferencefield name="link">
        <anchored width="20" height="20">
          <top offset="7" />
          <right offset="-6" />
        </anchored>
        <icon normal="button_link" />
        <noreset />
        <script file="ct/scripts/ct_link.lua"/>
      </windowreferencefield>
      
      <minibennyfield name="bennies">
        <anchored width="20" height="21">
          <top parent="link" />
          <right parent="link" anchor="left" offset="-5" />
        </anchored>
      </minibennyfield>
      
      <!-- Effects -->
      <ct_section name="effecticon">
        <anchored>
          <top offset="12" />
        </anchored>
        <icon>indicator_effect</icon>
        <script>
          function setSectionVisible(bVisible)
          bVisible = true
          window.effects.setVisible(bVisible)
          window.effects_label.setVisible(bVisible)
          setVisible(bVisible)
          end
        </script>
      </ct_section>
      <windowlist name="effects">
        <anchored>
          <left parent="effecticon" anchor="right" offset="52" />
          <top parent="damages" anchor="bottom" relation="relative" offset="-24" />
          <right offset="-10" />
        </anchored>
        <class>ct_effect</class>
        <datasource>.effects</datasource>
        <script file="ct/scripts/ct_effects.lua"/>
      </windowlist>
      <ct_section_label name="effects_label">
        <anchored to="effects" position="lefthigh" offset="4,6" />
        <static textres="ct_label_effects" />
      </ct_section_label>
      <string_ctentry_effects name="effect_summary">
        <anchored merge="replace">
          <left parent="wildcard_icon" offset="35" />
          <top parent="damages" anchor="bottom" relation="relative" offset="5" />
          <right offset="-17" />
        </anchored>
      </string_ctentry_effects>
      
      <label name="mb_command_label">
        <anchored>
          <top parent="damages" anchor="bottom" relation="relative"/>
          <left parent="effecticon" anchor="left"/>
        </anchored>
        <static textres="mb_command_label"/>
      </label>
      <comboboxc name="command_skill">
        <anchored to="mb_command_label" position="right" offset="15" width="120">
        </anchored>
        <script file="MassBattles/scripts/participation_combobox.lua"/>
        <default>--</default>
        <listdirection mergerule="replace">down</listdirection>
      </comboboxc>
      <button_text name="commandButton" merge="replace">
        <script>
          function onButtonPress()
          local sActorType, sActorLink = window.link.getValue()
          local sSkill = window.command_skill.getValue()
          local nodeActor = DB.findNode(sActorLink)
          ModifierManager.applyEffectModifierOnEntity(sActorType, nodeActor, "battlecommand")
          local sDescPrefix = Interface.getString("mb_command_roll_prefix")
          local nodeTrait = SkillManager.getSkillNode(nodeActor, sSkill, true)
          TraitManager.rollPreDefinedRoll(sActorType, nodeActor, nodeTrait, sDescPrefix, "battlecommand", {["mb_entry"]=window.getDatabaseNode().getPath()})
          end
        </script>
        <anchored to="command_skill" position="right" offset="10" width="80"/>
        <text>Command!</text>
      </button_text>
      
      <vspace name="spacer">
        <anchored height="20">
          <top parent="damages" anchor="bottom" relation="relative" />
          <left />
          <right />
        </anchored>
      </vspace>
    </sheetdata>
  </windowclass>
  <windowclass name="mbResolutionWindow">
    <frame name="groupbox"/>
    <script file="MassBattles/scripts/mb_resolution_box.lua"/>
    <sheetdata>
      <massbattle_center_anchor name="resultWindowCenterAnchor"/>
      <label name="forceALabel">
        <static>Result</static>
        <anchored position="insidetopleft" offset="10,5"/>
      </label>
      <number name="armyacommandresult">
        <anchored to="forceALabel" position="right" offset="10"/>
      </number>
      <number name="armybcommandresult">
        <anchored position="insidetopright" offset="10,5"/>
      </number>
      <label name="forceBLabel">
        <static>Result</static>
        <anchored>
          <left anchor="right" parent="armybcommandresult" offset="10"/>
          <top parent="armybcommandresult"/>
        </anchored>
      </label>
      <label name="armyalossesLabel">
        <static>Losses:</static>
        <anchored position="insidetopleft" offset="10,15"/>
      </label>
      <number name="armyalosses">
        <anchored to="armyalossesLabel" position="right" offset="10"/>
      </number>
      <number name="armyblosses">
        <anchored position="insidetopright" offset="10,15"/>
      </number>
      <label name="armyblossesLabel">
        <static>Losses:</static>
        <anchored>
          <left anchor="right" parent="armyblosses" offset="10"/>
          <top parent="armyblosses"/>
        </anchored>
      </label>
      <button_text name="accept_round_results">
        <script>
          function onButtonPress()
            MassBattles.acceptCommandResults()
          end
        </script>
        <text>Accept</text>
        <anchored width="80" height="15">
          <top parent="resultWindowCenterAnchor" anchor="bottom" relation="relative" offset="35"/>
          <left anchor="left" parent="resultWindowCenterAnchor" offset="-40"/>
        </anchored>
      </button_text>
    </sheetdata>
    
  </windowclass>
  <windowclass name="mbMoraleBox">
    <frame name="groupbox"/>
    <script file="MassBattles/scripts/mb_morale_box.lua"/>
    <sheetdata>
      <massbattle_center_anchor name="resultWindowCenterAnchor"/>
      <button_text name="armyAMoraleButton">
        <textres>mb_morale_check_button</textres>
        <script>
           function onButtonPress()
             local sActorType, sActorLink = MassBattles.getLeaderA()
             local sAttribute = "Spirit"
             local nodeActor = DB.findNode(sActorLink)
             ModifierManager.applyEffectModifierOnEntity(sActorType, nodeActor, "battlemorale")
             local sDescPrefix = Interface.getString("mb_morale_roll_prefix")
             local nodeAttribute = AttributeManager.getAttributeNode(nodeActor, sAttribute)
             CustomData = {}
             CustomData.mb_entry = MassBattles.getLeaderADetails().getPath()
             Debug.chat("sActorType",sActorType, "nodeActor",nodeActor, "nodeTrait",nodeAttribute, "sDescPrefix",sDescPrefix, "battlemorale")
             TraitManager.rollPreDefinedRoll(sActorType, nodeActor, nodeAttribute, sDescPrefix, "battlemorale",CustomData)
           end
        </script>
        <anchored width="60" height="15">
          <bottom offset="-10"/>
          <left offset="10" />
        </anchored>
      </button_text>
      <label name="armyANoCheckRequiredLabel">
        <static textres="mb_no_morale_check_required"/>
        <anchored width="60">
          <top />
          <bottom offset="-10"/>
          <left offset="10" />
        </anchored>
        <multilinespacing>12</multilinespacing>
        <center/>
      </label>
      <button_text name="armyBMoraleButton">
        <script>
           function onButtonPress()
             local sActorType, sActorLink = MassBattles.getLeaderB()
             local sAttribute = "Spirit"
             local nodeActor = DB.findNode(sActorLink)
             ModifierManager.applyEffectModifierOnEntity(sActorType, nodeActor, "battlemorale")
             local sDescPrefix = Interface.getString("mb_morale_roll_prefix")
             local nodeAttribute = AttributeManager.getAttributeNode(nodeActor, sAttribute)
             CustomData = {}
             CustomData.mb_entry = MassBattles.getLeaderBDetails().getPath()
             Debug.chat("sActorType",sActorType, "nodeActor",nodeActor, "nodeTrait",nodeAttribute, "sDescPrefix",sDescPrefix, "battlemorale")
             TraitManager.rollPreDefinedRoll(sActorType, nodeActor, nodeAttribute, sDescPrefix, "battlemorale",CustomData)
           end
        </script>
        <textres>mb_morale_check_button</textres>
        <anchored width="60" height="15">
          <bottom offset="-10"/>
          <right offset="-10" />
        </anchored>
      </button_text>
      <label name="armyBNoCheckRequiredLabel">
        <static textres="mb_no_morale_check_required"/>
        <anchored width="60">
          <top />
          <bottom offset="-10"/>
          <right offset="-10" />
        </anchored>
        <multilinespacing>12</multilinespacing>
      </label>
    </sheetdata>
  </windowclass>
  <template name="hint">
    <stringfield>
      <script>
        function onInit()
          window.registerHint(tonumber(self.index[1]),self.getName())
        end
      </script>
      <index>0</index>
    </stringfield>
  </template>
  <windowclass name="HintWindowGM">
    <script file="MassBattles/scripts/mb_hint_window.lua"/>
    <sheetdata>
      <hint name="Hint1">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm1"/>
        <multilinespacing>12</multilinespacing>
        <index>1</index>
      </hint>
      <hint name="Hint2">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm2"/>
        <invisible/>
        <multilinespacing>12</multilinespacing>
        <index>2</index>
      </hint>
      <hint name="Hint3">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm3"/>
        <invisible/>
        <multilinespacing>12</multilinespacing>
        <index>3</index>
      </hint>
      <hint name="Hint4">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm4"/>
        <invisible/>
        <multilinespacing>12</multilinespacing>
        <index>4</index>
      </hint>
    </sheetdata>
  </windowclass>
  <windowclass name="HintWindowCL">
    <script file="MassBattles/scripts/mb_hint_window.lua"/>
    <sheetdata>
      <hint name="Hint1">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm1"/>
        <multilinespacing>12</multilinespacing>
        <index>1</index>
      </hint>
      <hint name="Hint2">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm2"/>
        <invisible/>
        <multilinespacing>12</multilinespacing>
        <index>2</index>
      </hint>
      <hint name="Hint3">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm3"/>
        <invisible/>
        <multilinespacing>12</multilinespacing>
        <index>3</index>
      </hint>
      <hint name="Hint4">
        <anchored position="insideleft"/>
        <static textres="mb_hints_gm4"/>
        <invisible/>
        <multilinespacing>12</multilinespacing>
        <index>4</index>
      </hint>
    </sheetdata>
  </windowclass>
  <template name="client_mb_state">
    <genericcontrol>
      <stateframe>
        <drophilight name="modstackfocus" offset="2,1,1,1" hidereadonly="true" />
      </stateframe>
      <droptypes>
        <type>benny</type>
      </droptypes>
      <script>
        function onInit()
         window.inc.getDatabaseNode().onUpdate = onStateChanged
         onStateChanged()
        end
        function onStateChanged()
          setReadOnly(true)
          if window.inc.getValue() == 1 then
            setIcon("state_inc")
          else
            setIcon("")
          end
          setVisible(hasIcon())
        end
      </script>
    </genericcontrol>
  </template>
  <font name="battle_impact_font">
    <ttf file="graphics/fonts/Noto_Sans/NotoSans-Bold.ttf" name="Noto Sans Bold" size="24" />
    <color value="000000" />
  </font>
  <font name="force_token_font">
    <ttf file="graphics/fonts/Noto_Sans/NotoSans-Bold.ttf" name="Noto Sans Bold" size="40" />
    <color value="000000" />
  </font>
  <font name="battle_impact_effect_font">
    <ttf file="graphics/fonts/Noto_Sans/NotoSans-Bold.ttf" name="Noto Sans" size="20" />
    <color value="000000" />
  </font>
  <font name="armynamefont">
    <ttf file="graphics/fonts/Noto_Sans/NotoSans-Bold.ttf" name="Noto Sans" size="28" />
    <color value="000000" />
  </font>
  <font name="settings_title_font">
    <ttf file="graphics/fonts/Noto_Sans/NotoSans-Bold.ttf" name="Noto Sans" size="18" />
    <color value="000000" />
  </font>
</root>
